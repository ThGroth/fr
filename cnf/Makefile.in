#############################################################################
##
#W Makefile                                                 Laurent Bartholdi
##
#H   @(#)$Id$
##
#Y Copyright (C) 2007, Laurent Bartholdi
##
#############################################################################
##
##  This creates archives, or compiles the documentation
##
#############################################################################

.PHONY: all lib doc clean distribute mrproper wwwdir checkblocks tarballs

PWDU:=$(shell dirname $(PWD))
PWDUU:=$(shell dirname $(PWDU))

LOCALBIN=bin/@GAPARCH@

all: $(LOCALBIN)

distribute: wwwdir doc tarballs

$(LOCALBIN):
	mkdir -p $(LOCALBIN)

clean:
	rm -rf .version config.log $(LOCALBIN) `find doc -type l`

mrproper: clean
	rm Makefile

configure: cnf/Makefile.in cnf/configure.ac
	(cd cnf; aclocal -Im4; autoconf; mv -f configure ..)

.version: PackageInfo.g
	grep '^Version :=' $< | awk -F'"' '{print $$2}' > $@

doc: doc/chap0.html

doc/chap0.html: doc/fr.xml doc/frbib.xml gap/algebra.gd gap/frelement.gd \
	gap/group.gd gap/perlist.gd gap/vector.gd gap/examples.gd \
	gap/frmachine.gd gap/helpers.gd gap/mealy.gd gap/trans.gd
	echo 'LoadPackage("fr"); DOC@FR();' | @GAP_EXEC@ -r -q -l ";$(PWDUU)"
	(cd doc; git add *.html manual.pdf manual.css; git commit -m 'New html files'; git push github master:gh-pages)

checkblocks:
	grep '<#GAPDoc' PackageInfo.g gap/*d | awk -F'"' '{print $$2}' | sort > @@-blocks
	grep '<#Include' doc/fr.xml | awk -F'"' '{print $$2}' | sort > @@-in
	comm -3 @@-blocks @@-in
	@rm @@-blocks @@-in

tarballs: .version doc
	mkdir -p www
	tar -c -f - --exclude '*~' --exclude '.[a-z]*' --exclude 'config.[ls]*' --exclude 'fr/Makefile*' --exclude autom4te.cache --exclude sandbox --exclude www --exclude bin --exclude CVS -C .. fr | (cd www; tar -x -f -)
	tar -c -f www/fr-`cat .version`.tar.gz -z -C www fr
	ln -sf fr-`cat .version`.tar.gz www/fr.tar.gz

#E Makefile . . . . . . . . . . . . . . . . . . . . . . . . . . . ends here
